# -*- mode: ruby -*-
# vi: set ft=ruby :
# Kubernetes Cluster (1 Master + 2 Workers) using Rocky Linux 9
VAGRANT_API_VERSION = "2"

Vagrant.configure(VAGRANT_API_VERSION) do |config|
  BOX_NAME = "generic/rocky9"

  config.vm.provider "virtualbox" do |vb|
    vb.memory = 3072
    vb.cpus = 2
  end

  config.vm.box_check_update = false

  # Define host entries for cluster nodes
  HOSTS_CONTENT = <<-EOF
192.168.57.10   master
192.168.57.11   worker1
192.168.57.12   worker2
EOF

  # Common setup for all nodes
  COMMON_SETUP = <<-SHELL
    echo ">>> Disabling swap, SELinux, and firewalld..."
    sudo swapoff -a
    sudo sed -i '/swap/d' /etc/fstab
    sudo sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config
    sudo setenforce 0
    sudo systemctl disable --now firewalld || true

    echo ">>> Installing EPEL repository..."
    sudo dnf install -y epel-release

    echo ">>> Adding Docker CE repository..."
    sudo dnf -y install dnf-plugins-core
    sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

    echo ">>> Adding Kubernetes repository..."
    cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
EOF

    echo ">>> Cleaning and updating DNF cache..."
    sudo dnf clean all
    sudo dnf makecache

    echo ">>> Installing containerd..."
    sudo dnf install -y containerd.io
    sudo mkdir -p /etc/containerd
    containerd config default | sudo tee /etc/containerd/config.toml >/dev/null
    sudo systemctl enable --now containerd

    echo ">>> Installing Kubernetes tools..."
    sudo dnf install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
    sudo systemctl enable kubelet

    echo ">>> Loading kernel modules and configuring sysctl..."
    sudo modprobe overlay
    sudo modprobe br_netfilter

    cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

    cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

    sudo sysctl --system

    echo ">>> Updating /etc/hosts..."
    cat <<EOF | sudo tee -a /etc/hosts
#{HOSTS_CONTENT}
EOF

    echo ">>> Node setup complete!"
  SHELL

  # Define Master Node
  config.vm.define "master" do |master|
    master.vm.box = BOX_NAME
    master.vm.hostname = "master"
    master.vm.network "private_network", ip: "192.168.57.10"
    master.vm.provision "shell", inline: <<-SHELL
      hostnamectl set-hostname master
      #{COMMON_SETUP}
      echo ">>> Master node ready for kubeadm init!"
    SHELL
  end

  # Define Worker Nodes
  ["worker1", "worker2"].each_with_index do |name, i|
    config.vm.define name do |node|
      node.vm.box = BOX_NAME
      node.vm.hostname = name
      node.vm.network "private_network", ip: "192.168.57.#{11 + i}"
      node.vm.provision "shell", inline: <<-SHELL
        hostnamectl set-hostname #{name}
        #{COMMON_SETUP}
        echo ">>> Worker node #{name} ready!"
      SHELL
    end
  end
end

